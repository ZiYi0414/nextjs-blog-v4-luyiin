---
title: 'composition event ğŸ¤”'
description: 'ä½¿ç”¨Ant Designçš„Selectæœç´¢æ¡†ï¼Œç›‘å¬compositionï¼Œè¾“å…¥ç»“æŸåå†æœç´¢ã€‚'
publishedAt: '2020-07-21'
tags: 'Share'
---

ä¸­æ–‡è¾“å…¥æ³•ï¼ˆåŒ…æ‹¬ CJK è¾“å…¥æ³•ï¼‰éƒ½æœ‰çš„é—®é¢˜ï¼šå¦‚æœ`<input>`ä¸Šç›‘å¬[input äº‹ä»¶](https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/input_event)ï¼Œåœ¨ Win/Mac ä¸Šæ¯æ¬¡æŒ‰é”®éƒ½ä¼šè§¦å‘ã€‚ä¾‹å¦‚ç”¨æ‹¼éŸ³è¾“å…¥æ³•è¾“å…¥åŠ¨æ¼«é©¿ç«™ï¼Œç”¨æˆ·å¯èƒ½æŒ‰é”® d.o.n.g.m.aâ€¦ä¼šè§¦å‘ 13 æ¬¡äº‹ä»¶ï¼Œä½†å…¶å®åªéœ€è¦è§¦å‘ä¸€æ¬¡å¤„ç†è¾“å…¥åçš„ç»“æœã€‚æ—©å¹´é—´æœ‰å¾ˆå¤š trick çš„åšæ³•ï¼Œæ¯”å¦‚ keyup åˆ¤æ–­è¾“å…¥æ¡†å†…å®¹æ˜¯å¦æ˜¯ä¸­æ–‡ã€‚ç°åœ¨æ˜¯å¯ä»¥æ”¾å¿ƒä½¿ç”¨[composition äº‹ä»¶](https://developer.mozilla.org/en-US/docs/Web/API/Element/compositionstart_event)äº†ã€‚

åœºæ™¯æ˜¯ï¼šä½¿ç”¨[Ant Design çš„ Select æœç´¢æ¡†](https://ant.design/components/select/#components-select-demo-search-box)ï¼Œç›‘å¬ compositionï¼Œè¾“å…¥ç»“æŸåå†æœç´¢ã€‚

å› ä¸ºåªæ˜¯è¾“å…¥çš„åˆ¤æ–­ï¼Œä½¿ç”¨ state/hook åè€Œå¤æ‚äº†ï¼Œç”¨ä¸€ä¸ªå…¨å±€å˜é‡æ ‡è®°æ˜¯å¦æ­£åœ¨è¾“å…¥ï¼Œcompositionstart ä¸º trueï¼Œcompositionend èµ‹å€¼ falseï¼Œåœ¨è·å–æ•°æ®å‰æ£€æŸ¥è¿™ä¸ªæ ‡è®°ï¼Œæ˜¯ false æ‰è·å–ï¼Œä¸»è¦ä»£ç å¦‚ä¸‹ï¼š

```JavaScript
window.isInputing = false;
  const Form = (props) => {
    const compositionListener = (e) => {
      window.isInputing = e.type === 'compositionstart';
    };
    const fetchData = (v) => {
      if (window.isInputing === false) {
        fetch();
      }
    };

    return (
      <Select
        showSearch
        value={v}
        onSearch={v => fetchData(v)}
      />
    );
  }
```

å¦‚æœæ˜¯æ™®é€š`<input>`å¯ä»¥ç›´æ¥addEventListenerï¼Œä½†è¿™é‡Œçš„`<Select>`æ˜¯ç»„ä»¶ï¼Œè€Œä¸”æ²¡æœ‰onChange/onInputã€‚ä»onFocusä¹Ÿè·å–ä¸åˆ°å®é™…çš„å…ƒç´ ï¼Œå®ƒæ˜¯ä¸€ä¸ªsetTimeoutã€‚æ‰€ä»¥æŒ‰ç…§æ–‡æ¡£æè¿°ç°æˆçš„åªèƒ½ç”¨onInputKeyDownäº†ï¼Œä¿®æ”¹`<Select>`ï¼š

```JavaScript
  return (
    <Select
      showSearch
      value={v}
      onSearch={v => fetchData(v)}
      onInputKeyDown={(e) => {
        const el = e.nativeEvent.target;
        el.addEventListener('compositionstart', compositionListener);
        el.addEventListener('compositionend', compositionListener);
      }}
    />
  );
}
```

è¿™ä¹ˆå†™å°±å†’å‡ºå‡ ç§å¯èƒ½æ€§ï¼š

- å¦‚æœæŒ‰ç…§ä¹‹å‰çš„å†™æ³•ï¼ŒcompositionListenerå‡½æ•°åœ¨ç»„ä»¶å†…ï¼Œæµè§ˆå™¨è®¤ä¸ºæ˜¯ä¸åŒçš„äº‹ä»¶ï¼Œä¼šè¢«é‡å¤ç»‘å®šã€‚è¦æ‰‹åŠ¨æ·»åŠ ä¸€ä¸ªæ ‡è®°ï¼Œæ¯”å¦‚ä¿®æ”¹å…ƒç´ çš„datasetï¼Œé¿å…é‡å¤ç»‘å®šã€‚
- æŠŠcompositionListenerå‡½æ•°æ”¾åœ¨ç»„ä»¶å¤–ï¼Œåªä¼šè¢«ç»‘å®šä¸€æ¬¡ï¼Œä½†è¦è°ƒç”¨ç»„ä»¶å†…éƒ¨çš„å‡½æ•°â€”â€”æ¯”å¦‚fetchDataâ€”â€”å°±å˜å¤æ‚äº†ã€‚
- ç»‘å®šCompositionäº‹ä»¶åï¼Œåœ¨Chromeæµè§ˆå™¨ä¹Ÿæ˜¯å…ˆè§¦å‘onChangeï¼Œæ‰åˆ°compositionendã€‚ä¹Ÿå°±æ˜¯åœ¨æ”¹å˜å…¨å±€å˜é‡æ ‡è®°å‰å·²ç»æ‰§è¡Œäº†onSearchã€‚

æš‚æ—¶ä¸è€ƒè™‘æŠŠfetchDataå†™æˆhookçš„æ–¹æ¡ˆï¼Œåªåœ¨ç°æœ‰ä»£ç åŸºç¡€ä¸Šæ”¹åŠ¨ï¼Œä¸€æ—¶æƒ³ä¸å‡ºæœ€ä¼˜å†™æ³•ï¼Œå…ˆæ”¹æˆäº†å¦‚æœæ˜¯Chromeæµè§ˆå™¨æ‰§è¡Œä¸€æ¬¡fetchDataã€‚

```JavaScript
 const compositionListener = (e) => {
    window.isInputing = e.type === 'compositionstart';
    if (window.chrome) {
      fetchData(e.target.value);
    }
  };
```
æ€»ç»“æ¥çœ‹ç›¸å¯¹éº»çƒ¦çš„è¿˜æ˜¯CompositionEventï¼Œéƒ½2020å¹´äº†é—®é¢˜ä»ç„¶å­˜åœ¨ã€‚ä»¥å‰ç”¨setTimeoutå»¶è¿Ÿ100mså·¦å³ï¼Œç­‰compositionendæ”¹å˜äº†å…¨å±€å˜é‡çš„å€¼å†åšåç»­å¤„ç†ã€‚